#  Copyright 2025 Google Inc.
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.
#
#  NOTE: This is not an officially supported Google product

steps:
  # Step 1: Build all three container images in parallel
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Build RP Image'
    args: ['builds', 'submit', './fedcm/fedcm-rp-demo', '--tag=gcr.io/$PROJECT_ID/fedcm-demo-rp:$SHORT_SHA']

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Build IdP Image'
    args: ['builds', 'submit', './fedcm/fedcm-idp-demo', '--tag=gcr.io/$PROJECT_ID/fedcm-demo-idp:$SHORT_SHA']

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Build IdP-2 Image'
    args: ['builds', 'submit', './fedcm/fedcm-another-idp-demo', '--tag=gcr.io/$PROJECT_ID/fedcm-demo-idp-2:$SHORT_SHA']

  # Step 2: Deploy all three services. This happens after all builds are complete.
  # We use the env.prod.yaml file you created, which should be in the fedcm/ directory.
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy RP Service'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'fedcm-demo-rp'
      - '--image=gcr.io/$PROJECT_ID/fedcm-demo-rp:$SHORT_SHA'
      - '--region=us-central1'
      - '--env-vars-file=./fedcm/env.prod.yaml' # Assumes your env file is in the fedcm folder
      - '--quiet' # Prevents interactive prompts

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy IdP Service'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'fedcm-demo-idp'
      - '--image=gcr.io/$PROJECT_ID/fedcm-demo-idp:$SHORT_SHA'
      - '--region=us-central1'
      - '--env-vars-file=./fedcm/env.prod.yaml'
      - '--quiet'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy IdP-2 Service'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'fedcm-demo-idp-2' # Change this if your service name is different
      - '--image=gcr.io/$PROJECT_ID/fedcm-demo-idp-2:$SHORT_SHA'
      - '--region=us-central1'
      - '--env-vars-file=./fedcm/env.prod.yaml'
      - '--quiet'

# Specify which images to push to the registry upon successful build
images:
  - 'gcr.io/$PROJECT_ID/fedcm-demo-rp:$SHORT_SHA'
  - 'gcr.io/$PROJECT_ID/fedcm-demo-idp:$SHORT_SHA'
  - 'gcr.io/$PROJECT_ID/fedcm-demo-idp-2:$SHORT_SHA'
